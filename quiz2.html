<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Astrid-Lindgren-Schule Duisburg</title>
    <style>
        /* [Alle bestehenden CSS-Stile bleiben gleich] */
        
        /* NEUE STILE F√úR GITHUB PAGES */
        .github-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            color: #856404;
        }
        
        .results-download {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }
        
        .results-download h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .download-instructions {
            text-align: left;
            max-width: 600px;
            margin: 1rem auto;
            background: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .download-instructions ol {
            margin-left: 1.5rem;
        }
        
        .download-instructions li {
            margin-bottom: 0.5rem;
        }
        
        .qr-code {
            margin: 2rem auto;
            padding: 1rem;
            background: white;
            display: inline-block;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .github-help {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- [Header bleibt gleich] -->
    
    <main>
        <section class="intro">
            <h1>Quiz</h1>
            <p>Testen Sie Ihr Wissen! Falsch beantwortete Fragen werden am Ende wiederholt.</p>
            
            <!-- Info f√ºr GitHub Pages -->
            <div class="github-warning">
                <strong>‚ÑπÔ∏è Wichtig f√ºr Lehrer:</strong> Ergebnisse werden lokal gespeichert und k√∂nnen exportiert werden.
                F√ºr die Sammlung der Ergebnisse bitte die Export-Funktion nutzen.
            </div>
        </section>

        <!-- Modal f√ºr Sch√ºlerinformationen -->
        <div class="modal" id="studentModal">
            <div class="modal-content">
                <h3>Sch√ºlerinformationen</h3>
                <p>Bitte geben Sie Ihre Daten f√ºr das Quiz ein:</p>
                
                <div class="form-group">
                    <label for="studentName">Vorname:*</label>
                    <input type="text" id="studentName" placeholder="Max" required>
                </div>
                
                <div class="form-group">
                    <label for="studentClass">Klasse:*</label>
                    <input type="text" id="studentClass" placeholder="4a" required>
                </div>
                
                <div class="form-group">
                    <label for="studentId">Sch√ºler-ID (optional):</label>
                    <input type="text" id="studentId" placeholder="12345">
                </div>
                
                <div class="github-help">
                    <small>Die Daten werden nur in Ihrem Browser gespeichert und k√∂nnen exportiert werden.</small>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-button secondary" id="cancelButton">Abbrechen</button>
                    <button class="modal-button primary" id="startQuizButton">Quiz starten</button>
                </div>
            </div>
        </div>

        <div class="quiz-container">
            <!-- Quiz-Bereich -->
            <div id="quiz-area" style="display: none;">
                <div class="quiz-status">
                    <div id="status-text">Frage 1 von <span id="total-questions">0</span></div>
                    <div class="progress-bar">
                        <div class="progress" id="progress-bar"></div>
                    </div>
                </div>

                <div class="question-card" id="question-card">
                    Das Quiz beginnt in K√ºrze...
                </div>

                <div class="answers-grid" id="answers-container">
                    <!-- Antwort-Cards werden hier dynamisch eingef√ºgt -->
                </div>

                <div class="result-container" id="result-container">
                    <h2>Quiz abgeschlossen!</h2>
                    <p>Ihr Ergebnis:</p>
                    <div class="score" id="final-score">0%</div>
                    <p id="result-message"></p>
                    <button class="restart-button" id="restart-button">Quiz neu starten</button>
                    <button class="toggle-results" id="showResultsButton">Ergebnisse anzeigen</button>
                </div>
            </div>

            <!-- Ergebnisse-Aufzeichnung -->
            <div class="results-section" id="resultsSection">
                <h3>üìä Quiz-Ergebnisse</h3>
                
                <div class="results-summary">
                    <h4>Aktuelle Statistiken</h4>
                    <div class="statistics-grid" id="statisticsGrid">
                        <!-- Statistik-Karten werden hier dynamisch eingef√ºgt -->
                    </div>
                </div>
                
                <h4>Gespeicherte Ergebnisse (lokal im Browser)</h4>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Datum/Zeit</th>
                            <th>Name</th>
                            <th>Klasse</th>
                            <th>Fragen</th>
                            <th>Richtig</th>
                            <th>Falsch</th>
                            <th>Fehlerquote</th>
                            <th>Wiederholungen</th>
                            <th>Punkte</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- Ergebnisse werden hier dynamisch eingef√ºgt -->
                    </tbody>
                </table>
                
                <div class="export-buttons">
                    <button class="export-button" id="exportJSON">üì• Ergebnisse als JSON</button>
                    <button class="export-button secondary" id="exportCSV">üìä Ergebnisse als CSV</button>
                    <button class="export-button" id="clearResults">üóëÔ∏è Lokale Daten l√∂schen</button>
                </div>
                
                <!-- Bereich f√ºr Lehrer-Download -->
                <div class="results-download">
                    <h4>üìã Anleitung f√ºr Lehrkr√§fte</h4>
                    <p>So sammeln Sie die Ergebnisse aller Sch√ºler:</p>
                    
                    <div class="download-instructions">
                        <ol>
                            <li>Jeder Sch√ºler f√ºhrt das Quiz auf seinem Ger√§t durch</li>
                            <li>Am Ende klickt jeder auf "Ergebnisse als CSV"</li>
                            <li>Die CSV-Datei speichern und an die Lehrkraft senden</li>
                            <li>Lehrkraft sammelt alle CSV-Dateien und kann sie in Excel zusammenf√ºhren</li>
                        </ol>
                    </div>
                    
                    <button class="export-button secondary" id="exportSummaryCSV">
                        üìà Zusammenfassung als CSV
                    </button>
                    
                    <div class="github-help">
                        <strong>Tipp:</strong> F√ºr die Klassenauswertung alle CSV-Dateien in Excel √∂ffnen
                        und mit "Daten aus Text/CSV" importieren.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- [Footer bleibt gleich] -->

    <script>
        // Quiz-Daten
        let questions = [];
        let currentQuestionIndex = 0;
        let wrongQuestions = [];
        let score = 0;
        let totalQuestions = 0;
        let isAnswerSelected = false;
        let currentRound = 1;
        
        // Sch√ºlerinformationen
        let studentData = {
            name: '',
            className: '',
            studentId: ''
        };
        
        // Ergebnis-Datenbank
        let resultsDatabase = [];

        // DOM-Elemente
        const questionCard = document.getElementById('question-card');
        const answersContainer = document.getElementById('answers-container');
        const resultContainer = document.getElementById('result-container');
        const statusText = document.getElementById('status-text');
        const progressBar = document.getElementById('progress-bar');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const finalScore = document.getElementById('final-score');
        const resultMessage = document.getElementById('result-message');
        const restartButton = document.getElementById('restart-button');
        const quizArea = document.getElementById('quiz-area');
        const resultsSection = document.getElementById('resultsSection');
        const showResultsButton = document.getElementById('showResultsButton');
        const exportJSONButton = document.getElementById('exportJSON');
        const exportCSVButton = document.getElementById('exportCSV');
        const exportSummaryCSVButton = document.getElementById('exportSummaryCSV');
        const clearResultsButton = document.getElementById('clearResults');
        const resultsBody = document.getElementById('resultsBody');
        const statisticsGrid = document.getElementById('statisticsGrid');
        
        // Modal-Elemente
        const studentModal = document.getElementById('studentModal');
        const studentNameInput = document.getElementById('studentName');
        const studentClassInput = document.getElementById('studentClass');
        const studentIdInput = document.getElementById('studentId');
        const startQuizButton = document.getElementById('startQuizButton');
        const cancelButton = document.getElementById('cancelButton');

        // Farben f√ºr die Karten
        const cardColors = ['color-green', 'color-yellow', 'color-orange', 'color-red'];
        const cardBackgrounds = ['bg-leitbild', 'bg-montessori', 'bg-klassen', 'bg-team'];

        // Fallback-Fragen (EINGEBETTET f√ºr GitHub Pages)
        const fallbackQuestions = [
            {
                question: "Was ist richtig geschrieben?",
                answers: ["Schuler", "Sch√ºler", "Sch√ºller", "Schuller"],
                correctAnswerIndex: 1
            },
            {
                question: "Was ist richtig geschrieben?",
                answers: ["Wise", "Wisse", "Wiesse", "Wiese"],
                correctAnswerIndex: 3
            },
            {
                question: "Welches Wort ist ein Nomen?",
                answers: ["laufen", "sch√∂n", "Haus", "schnell"],
                correctAnswerIndex: 2
            },
            {
                question: "Was ist die korrekte Pluralform?",
                answers: ["die H√§use", "die H√§user", "die Haiser", "die Hauses"],
                correctAnswerIndex: 1
            }
        ];

        // Initialisierung
        function init() {
            // Pr√ºfen, ob wir auf GitHub Pages sind
            const isGitHubPages = window.location.hostname.includes('github.io');
            
            // Modal immer anzeigen, auch wenn Daten gespeichert sind
            // (f√ºr GitHub Pages ist das besser, da mehrere Sch√ºler denselben Browser nutzen k√∂nnten)
            studentModal.style.display = 'flex';
            
            // Event-Listener f√ºr Modal
            startQuizButton.addEventListener('click', () => {
                if (validateStudentData()) {
                    studentModal.style.display = 'none';
                    startQuiz();
                }
            });
            
            cancelButton.addEventListener('click', () => {
                studentModal.style.display = 'none';
                quizArea.style.display = 'none';
                statusText.textContent = 'Quiz wurde abgebrochen';
            });
            
            // Event-Listener f√ºr Ergebnisse-Buttons
            showResultsButton.addEventListener('click', () => {
                showResults();
            });
            
            exportJSONButton.addEventListener('click', () => {
                exportResults('json');
            });
            
            exportCSVButton.addEventListener('click', () => {
                exportResults('csv');
            });
            
            exportSummaryCSVButton.addEventListener('click', () => {
                exportSummary();
            });
            
            clearResultsButton.addEventListener('click', () => {
                clearResults();
            });
            
            // Event-Listener f√ºr Neustart-Button
            restartButton.addEventListener('click', restartQuiz);
            
            // Ergebnisse laden
            loadResults();
            
            // GitHub Pages-spezifische Hinweise
            if (isGitHubPages) {
                console.log('Running on GitHub Pages - using local storage for results');
            }
        }

        // Sch√ºlerdaten validieren
        function validateStudentData() {
            const name = studentNameInput.value.trim();
            const className = studentClassInput.value.trim();
            
            if (!name || !className) {
                alert('Bitte geben Sie mindestens Vorname und Klasse ein.');
                return false;
            }
            
            studentData = {
                name: name,
                className: className,
                studentId: studentIdInput.value.trim() || 'keine ID',
                timestamp: new Date().toISOString()
            };
            
            return true;
        }

        // Quiz starten
        function startQuiz() {
            statusText.textContent = 'Fragen werden geladen...';
            quizArea.style.display = 'block';
            loadQuestions();
        }

        // Fragen laden (angepasst f√ºr GitHub Pages)
        function loadQuestions() {
            // Versuche zuerst, Fragen aus Datei zu laden
            fetch('Test.txt')
                .then(response => {
                    if (response.ok) return response.text();
                    throw new Error('Datei nicht gefunden');
                })
                .then(text => parseQuestionsFromText(text))
                .catch(error => {
                    console.log('Verwende eingebettete Fragen:', error);
                    useFallbackQuestions();
                });
        }

        // Ergebnisse laden
        function loadResults() {
            try {
                const savedResults = localStorage.getItem('quizResults_' + window.location.hostname);
                if (savedResults) {
                    resultsDatabase = JSON.parse(savedResults);
                    updateResultsDisplay();
                }
            } catch (e) {
                console.log('Keine gespeicherten Ergebnisse gefunden');
            }
        }

        // Ergebnisse speichern
        function saveResults(result) {
            try {
                resultsDatabase.push(result);
                localStorage.setItem('quizResults_' + window.location.hostname, JSON.stringify(resultsDatabase));
                updateResultsDisplay();
            } catch (e) {
                console.error('Fehler beim Speichern:', e);
                alert('Ergebnisse konnten nicht gespeichert werden. Bitte exportieren Sie sie sofort.');
            }
        }

        // Ergebnis-Display aktualisieren
        function updateResultsDisplay() {
            resultsBody.innerHTML = '';
            
            let totalCorrect = 0;
            let totalQuestions = 0;
            let totalAttempts = resultsDatabase.length;
            
            // Sortiere nach Datum (neueste zuerst)
            const sortedResults = [...resultsDatabase].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedResults.forEach((result, index) => {
                const row = document.createElement('tr');
                
                const errorRate = result.wrongAnswers > 0 ? 
                    Math.round((result.wrongAnswers / result.totalQuestions) * 100) : 0;
                const points = result.correctAnswers * 10;
                
                row.innerHTML = `
                    <td>${new Date(result.timestamp).toLocaleString('de-DE')}</td>
                    <td>${result.studentName}</td>
                    <td>${result.className}</td>
                    <td>${result.totalQuestions}</td>
                    <td style="color: #2ecc71;">${result.correctAnswers}</td>
                    <td style="color: #e74c3c;">${result.wrongAnswers}</td>
                    <td><strong>${errorRate}%</strong></td>
                    <td>${result.rounds - 1}</td>
                    <td><strong>${points}</strong></td>
                    <td>
                        <button onclick="deleteResult(${index})" style="
                            background: #e74c3c;
                            color: white;
                            border: none;
                            padding: 0.3rem 0.6rem;
                            border-radius: 3px;
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">L√∂schen</button>
                    </td>
                `;
                
                resultsBody.appendChild(row);
                
                totalCorrect += result.correctAnswers;
                totalQuestions += result.totalQuestions;
            });
            
            updateStatistics(totalAttempts, totalQuestions, totalCorrect);
        }

        // Einzelergebnis l√∂schen (global f√ºr Event-Listener)
        window.deleteResult = function(index) {
            if (confirm('Dieses Ergebnis wirklich l√∂schen?')) {
                resultsDatabase.splice(index, 1);
                localStorage.setItem('quizResults_' + window.location.hostname, JSON.stringify(resultsDatabase));
                updateResultsDisplay();
            }
        };

        // Statistiken aktualisieren
        function updateStatistics(totalAttempts, totalQuestions, totalCorrect) {
            const avgCorrect = totalAttempts > 0 ? Math.round(totalCorrect / totalAttempts) : 0;
            const avgErrorRate = totalQuestions > 0 ? 
                Math.round(((totalQuestions - totalCorrect) / totalQuestions) * 100) : 0;
            
            statisticsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>Quiz-Durchl√§ufe</h4>
                    <div class="value">${totalAttempts}</div>
                    <div class="subtext">In diesem Browser</div>
                </div>
                <div class="stat-card">
                    <h4>Durchschnitt richtig</h4>
                    <div class="value">${avgCorrect}</div>
                    <div class="subtext">Von ${totalAttempts > 0 ? totalQuestions/totalAttempts : 0} Fragen</div>
                </div>
                <div class="stat-card">
                    <h4>Fehlerquote</h4>
                    <div class="value">${avgErrorRate}%</div>
                    <div class="subtext">Durchschnittlich</div>
                </div>
                <div class="stat-card">
                    <h4>Bestes Ergebnis</h4>
                    <div class="value">${getBestResult()}%</div>
                    <div class="subtext">H√∂chste Punktzahl</div>
                </div>
            `;
        }

        // Bestes Ergebnis ermitteln
        function getBestResult() {
            if (resultsDatabase.length === 0) return 0;
            
            let bestScore = 0;
            resultsDatabase.forEach(result => {
                const score = Math.round((result.correctAnswers / result.totalQuestions) * 100);
                if (score > bestScore) bestScore = score;
            });
            
            return bestScore;
        }

        // Ergebnisse anzeigen
        function showResults() {
            resultsSection.style.display = 'block';
            quizArea.style.display = 'none';
            resultContainer.style.display = 'none';
        }

        // Ergebnisse exportieren
        function exportResults(format) {
            if (resultsDatabase.length === 0) {
                alert('Keine Ergebnisse zum Exportieren vorhanden.');
                return;
            }
            
            let data, mimeType, filename;
            
            if (format === 'json') {
                data = JSON.stringify(resultsDatabase, null, 2);
                mimeType = 'application/json';
                filename = `quiz_ergebnisse_${studentData.name}_${studentData.className}_${new Date().toISOString().split('T')[0]}.json`;
            } else if (format === 'csv') {
                // CSV im deutschen Format (Semikolon-getrennt)
                let csv = 'Datum;Name;Klasse;Sch√ºler-ID;Fragen gesamt;Richtig;Falsch;Fehlerquote %;Wiederholungen;Punkte\n';
                
                resultsDatabase.forEach(result => {
                    const errorRate = result.wrongAnswers > 0 ? 
                        Math.round((result.wrongAnswers / result.totalQuestions) * 100) : 0;
                    const points = result.correctAnswers * 10;
                    
                    csv += `"${new Date(result.timestamp).toLocaleString('de-DE')}";`;
                    csv += `"${result.studentName}";"${result.className}";"${result.studentId}";`;
                    csv += `${result.totalQuestions};${result.correctAnswers};${result.wrongAnswers};`;
                    csv += `${errorRate};${result.rounds - 1};${points}\n`;
                });
                
                data = csv;
                mimeType = 'text/csv;charset=utf-8;';
                filename = `quiz_${studentData.name}_${studentData.className}_${new Date().toISOString().split('T')[0]}.csv`;
            }
            
            // Datei herunterladen
            const blob = new Blob(['\ufeff' + data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Zusammenfassung exportieren (f√ºr Lehrer)
        function exportSummary() {
            if (resultsDatabase.length === 0) {
                alert('Keine Ergebnisse zum Exportieren vorhanden.');
                return;
            }
            
            // Gruppiere nach Sch√ºler
            const students = {};
            resultsDatabase.forEach(result => {
                const key = `${result.studentName}_${result.className}`;
                if (!students[key]) {
                    students[key] = {
                        name: result.studentName,
                        className: result.className,
                        attempts: 0,
                        totalCorrect: 0,
                        totalQuestions: 0,
                        bestScore: 0,
                        lastAttempt: ''
                    };
                }
                
                students[key].attempts++;
                students[key].totalCorrect += result.correctAnswers;
                students[key].totalQuestions += result.totalQuestions;
                
                const score = Math.round((result.correctAnswers / result.totalQuestions) * 100);
                if (score > students[key].bestScore) {
                    students[key].bestScore = score;
                }
                
                if (result.timestamp > students[key].lastAttempt) {
                    students[key].lastAttempt = result.timestamp;
                }
            });
            
            // CSV f√ºr Zusammenfassung
            let csv = 'Name;Klasse;Anzahl Versuche;Durchschnitt richtig;Durchschnitt Fehlerquote;Beste Leistung;Letzter Versuch\n';
            
            Object.values(students).forEach(student => {
                const avgCorrect = Math.round(student.totalCorrect / student.attempts);
                const avgQuestions = Math.round(student.totalQuestions / student.attempts);
                const avgErrorRate = Math.round(((student.totalQuestions - student.totalCorrect) / student.totalQuestions) * 100);
                
                csv += `"${student.name}";"${student.className}";`;
                csv += `${student.attempts};${avgCorrect}/${avgQuestions};${avgErrorRate}%;`;
                csv += `${student.bestScore}%;"${new Date(student.lastAttempt).toLocaleString('de-DE')}"\n`;
            });
            
            // Datei herunterladen
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `klassenauswertung_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Ergebnisse l√∂schen
        function clearResults() {
            if (confirm('M√∂chten Sie wirklich ALLE lokalen Ergebnisse l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                resultsDatabase = [];
                localStorage.removeItem('quizResults_' + window.location.hostname);
                updateResultsDisplay();
                alert('Alle lokalen Ergebnisse wurden gel√∂scht.');
            }
        }

        // Text in Fragen parsen
        function parseQuestionsFromText(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            questions = lines.map(line => {
                const cleanLine = line.replace(/#$/, '').trim();
                const parts = cleanLine.split(' - ');
                const question = parts[0].trim();
                const answers = [];
                let correctAnswerIndex = -1;
                
                for (let i = 1; i < parts.length; i++) {
                    let answer = parts[i].trim();
                    if (answer.endsWith('*')) {
                        answer = answer.slice(0, -1).trim();
                        correctAnswerIndex = i - 1;
                    }
                    answers.push(answer);
                }
                
                return { question, answers, correctAnswerIndex };
            });
            
            if (questions.length === 0) {
                throw new Error('Keine g√ºltigen Fragen gefunden');
            }
            
            totalQuestions = questions.length;
            totalQuestionsSpan.textContent = totalQuestions;
            updateProgress();
            showQuestion();
        }

        // Fallback-Fragen verwenden
        function useFallbackQuestions() {
            questions = [...fallbackQuestions];
            totalQuestions = questions.length;
            totalQuestionsSpan.textContent = totalQuestions;
            updateProgress();
            showQuestion();
        }

        // Frage anzeigen
        function showQuestion() {
            isAnswerSelected = false;
            answersContainer.innerHTML = '';
            
            const questionData = questions[currentQuestionIndex];
            
            if (!questionData) {
                if (wrongQuestions.length > 0) {
                    questions = [...wrongQuestions];
                    wrongQuestions = [];
                    currentQuestionIndex = 0;
                    currentRound++;
                    showQuestion();
                    return;
                } else {
                    showResultsAndSave();
                    return;
                }
            }
            
            questionCard.textContent = questionData.question;
            
            let roundText = '';
            if (currentRound === 1) {
                roundText = 'Erste Runde';
            } else if (currentRound === 2) {
                roundText = 'Wiederholungsrunde';
            } else {
                roundText = `${currentRound}. Wiederholungsrunde`;
            }
            
            statusText.textContent = `Frage ${currentQuestionIndex + 1} von ${questions.length} (${roundText})`;
            
            questionData.answers.forEach((answer, index) => {
                const answerCard = document.createElement('div');
                answerCard.className = `answer-card ${cardColors[index % cardColors.length]} ${cardBackgrounds[index % cardBackgrounds.length]} no-overlay`;
                
                const content = document.createElement('div');
                content.className = 'card-content';
                content.textContent = answer;
                
                answerCard.appendChild(content);
                answerCard.addEventListener('click', () => selectAnswer(index));
                
                answersContainer.appendChild(answerCard);
            });
            
            updateProgress();
        }

        // Antwort ausw√§hlen
        function selectAnswer(selectedIndex) {
            if (isAnswerSelected) return;
            
            isAnswerSelected = true;
            const questionData = questions[currentQuestionIndex];
            const answerCards = document.querySelectorAll('.answer-card');
            
            answerCards.forEach(card => {
                card.classList.add('disabled');
                card.style.cursor = 'not-allowed';
            });
            
            if (selectedIndex === questionData.correctAnswerIndex) {
                answerCards[selectedIndex].classList.add('correct');
                score++;
            } else {
                answerCards[selectedIndex].classList.add('wrong');
                answerCards[questionData.correctAnswerIndex].classList.add('correct');
                wrongQuestions.push(questionData);
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                
                if (currentQuestionIndex < questions.length) {
                    showQuestion();
                } else if (wrongQuestions.length > 0) {
                    currentQuestionIndex = 0;
                    questions = [...wrongQuestions];
                    wrongQuestions = [];
                    currentRound++;
                    showQuestion();
                } else {
                    showResultsAndSave();
                }
            }, 1500);
        }

        // Ergebnisse anzeigen UND speichern
        function showResultsAndSave() {
            const percentage = Math.round((score / totalQuestions) * 100);
            const wrongAnswers = totalQuestions - score;
            const errorRate = wrongAnswers > 0 ? Math.round((wrongAnswers / totalQuestions) * 100) : 0;
            
            finalScore.textContent = `${percentage}%`;
            
            let message = '';
            if (percentage >= 90) message = 'Ausgezeichnet! Sie sind ein wahrer Experte!';
            else if (percentage >= 70) message = 'Sehr gut! Sie haben ein gutes Wissen!';
            else if (percentage >= 50) message = 'Gut gemacht! √úbung macht den Meister.';
            else message = 'Weiter so! Jede √úbung bringt Sie weiter.';
            
            let repeatInfo = '';
            if (currentRound > 1) {
                repeatInfo = `Sie haben ${currentRound - 1} Wiederholungsrunde(n) gebraucht. `;
            }
            
            resultMessage.textContent = `${score} von ${totalQuestions} Fragen richtig beantwortet. Fehlerquote: ${errorRate}%. ${repeatInfo}${message}`;
            
            // Quiz-Bereich verstecken, Ergebnis anzeigen
            document.querySelector('.question-card').style.display = 'none';
            answersContainer.style.display = 'none';
            document.querySelector('.quiz-status').style.display = 'none';
            resultContainer.style.display = 'block';
            
            // Ergebnis speichern
            saveResult(percentage, wrongAnswers, errorRate);
        }

        // Einzelergebnis speichern
        function saveResult(percentage, wrongAnswers, errorRate) {
            const result = {
                timestamp: new Date().toISOString(),
                studentName: studentData.name,
                className: studentData.className,
                studentId: studentData.studentId || 'keine ID',
                totalQuestions: totalQuestions,
                correctAnswers: score,
                wrongAnswers: wrongAnswers,
                errorRate: errorRate,
                rounds: currentRound,
                percentage: percentage
            };
            
            saveResults(result);
        }

        // Fortschrittsbalken aktualisieren
        function updateProgress() {
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Quiz neustarten
        function restartQuiz() {
            currentQuestionIndex = 0;
            wrongQuestions = [];
            score = 0;
            currentRound = 1;
            
            document.querySelector('.question-card').style.display = 'block';
            answersContainer.style.display = 'grid';
            document.querySelector('.quiz-status').style.display = 'block';
            resultContainer.style.display = 'none';
            
            loadQuestions();
        }

        // Initialisierung beim Laden der Seite
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>